<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Cn.Mapper.InteractionMapper">

    <!-- 基础字段映射 -->
    <resultMap id="BaseResultMap" type="Cn.Poto.Vo.InteractionVO">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="product_id" property="productId"/>
        <result column="user_name" property="userName"/>
        <result column="user_account" property="userAccount"/>
        <result column="product_title" property="productTitle"/>
        <result column="type" property="type"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <!-- 新增互动记录 -->
    <insert id="save">
        INSERT INTO interaction (
            user_id,
            product_id,
            type,
            create_time
        ) VALUES (
                     #{userId},
                     #{productId},
                     #{type},
                     #{createTime}
                 )
    </insert>

    <!-- 批量删除互动记录 -->
    <delete id="batchDelete">
        DELETE FROM interaction
        WHERE id IN
        <foreach collection="ids" item="id"
                 open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 分页查询互动记录（带关联信息） -->
    <select id="query" resultMap="BaseResultMap">
        SELECT
        i.*,
        u.user_name,
        u.user_account,
        p.name AS product_title
        FROM interaction i
        LEFT JOIN user u ON u.id = i.user_id
        LEFT JOIN product p ON p.id = i.product_id
        <where>
            <if test="id != null">AND i.id = #{id}</if>
            <if test="userId != null">AND i.user_id = #{userId}</if>
            <if test="productId != null">AND i.product_id = #{productId}</if>
            <if test="type != null">AND i.type = #{type}</if>
            <if test="startTime != null and endTime != null">
                AND i.create_time BETWEEN #{startTime} AND #{endTime}
            </if>
        </where>
        ORDER BY i.id DESC
        <if test="current != null and size != null">
            LIMIT #{current}, #{size}
        </if>
    </select>

    <!-- 查询满足条件的记录总数 -->
    <select id="queryCount" resultType="int">
        SELECT COUNT(*) FROM interaction i
        <where>
            <if test="id != null">AND i.id = #{id}</if>
            <if test="userId != null">AND i.user_id = #{userId}</if>
            <if test="productId != null">AND i.product_id = #{productId}</if>
            <if test="type != null">AND i.type = #{type}</if>
            <if test="startTime != null and endTime != null">
                AND i.create_time BETWEEN #{startTime} AND #{endTime}
            </if>
        </where>
    </select>

    <!-- 根据商品ID集合查询互动记录 -->
    <select id="queryByProductIds" resultMap="BaseResultMap">
        SELECT i.*
        FROM interaction i
        WHERE i.product_id IN
        <foreach collection="ids" item="id"
                 open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 获取用户最近浏览的商品ID -->
    <select id="getRecentViews" resultType="int">
        SELECT product_id
        FROM interaction
        WHERE user_id = #{userId}
        AND type = 2  <!-- 2表示浏览类型 -->
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

</mapper>